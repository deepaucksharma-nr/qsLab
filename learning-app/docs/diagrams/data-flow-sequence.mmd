```mermaid
sequenceDiagram
    participant User as User/Operator
    participant Config as kafka-config.yml
    participant Main as nri-kafka Main
    participant Discovery as Discovery Service
    participant WorkerPool as Worker Pool Manager
    participant JMXWorker as JMX Worker Thread
    participant KafkaWorker as Kafka API Worker
    participant NRJMX as nrjmx Process
    participant Kafka as Kafka Cluster
    participant Processor as Data Processor
    participant Output as Output Handler
    participant Agent as NR Infra Agent
    participant Platform as New Relic

    User->>Config: Configure Integration
    User->>Main: Start nri-kafka
    
    Main->>Config: Load Configuration
    Config-->>Main: Parsed Config
    
    Main->>Main: Validate Config
    Main->>Main: Initialize SDK Integration
    
    Main->>Discovery: Initialize Discovery
    alt Bootstrap Discovery
        Discovery->>Kafka: Connect to Bootstrap Broker
        Kafka-->>Discovery: Cluster Metadata
    else Zookeeper Discovery
        Discovery->>Kafka: Connect to Zookeeper
        Kafka-->>Discovery: Broker List from /brokers/ids
    end
    
    Discovery-->>Main: Discovered Entities
    
    Main->>WorkerPool: Initialize Worker Pools
    WorkerPool->>WorkerPool: Create Broker Workers (3)
    WorkerPool->>WorkerPool: Create Topic Workers (5)
    WorkerPool->>WorkerPool: Create Client Workers (3)
    WorkerPool->>WorkerPool: Create Offset Workers (10)
```    
    loop Every Poll Interval (30s default)
        Main->>WorkerPool: Trigger Collection
        
        par Parallel Collection
            WorkerPool->>JMXWorker: Collect Broker Metrics
            JMXWorker->>NRJMX: Query MBeans
            NRJMX->>Kafka: JMX Query (Port 9999)
            Kafka-->>NRJMX: MBean Data
            NRJMX-->>JMXWorker: Parsed Metrics
            
        and
            WorkerPool->>JMXWorker: Collect Topic Metrics
            JMXWorker->>NRJMX: Query Topic MBeans
            NRJMX->>Kafka: JMX Query
            Kafka-->>NRJMX: Topic Metrics
            NRJMX-->>JMXWorker: Parsed Metrics
            
        and
            WorkerPool->>KafkaWorker: Collect Consumer Offsets
            KafkaWorker->>Kafka: List Consumer Groups
            Kafka-->>KafkaWorker: Consumer Groups
            KafkaWorker->>Kafka: Fetch Offsets
            Kafka-->>KafkaWorker: Offset Data
            KafkaWorker->>Kafka: Get Topic Metadata
            Kafka-->>KafkaWorker: Partition End Offsets
            KafkaWorker->>KafkaWorker: Calculate Lag
        end
        
        JMXWorker-->>WorkerPool: Collected Metrics
        KafkaWorker-->>WorkerPool: Offset/Lag Data
        
        WorkerPool->>Processor: Process Raw Data
        
        Processor->>Processor: Transform Metrics
        Processor->>Processor: Calculate Deltas
        Processor->>Processor: Apply Filters
        Processor->>Processor: Enrich with Tags
        Processor->>Processor: Create NR Samples
        
        Processor->>Output: Formatted Samples
        
        Output->>Output: Build JSON Payload
        Output->>Output: Batch if Needed
        Output->>Agent: Write to STDOUT
        
        Agent->>Agent: Parse JSON
        Agent->>Agent: Validate Protocol
        Agent->>Platform: Send to New Relic
        
        Platform-->>Agent: Acknowledge
        Agent-->>Output: Success
        
        alt Error Occurred
            Processor->>Processor: Log Error
            Processor->>Processor: Increment Error Counter
            Processor->>Processor: Check Circuit Breaker
            
            alt Circuit Open
                Processor->>Processor: Skip Entity
                Processor->>Processor: Wait for Recovery
            else Circuit Closed
                Processor->>Processor: Retry with Backoff
            end
        end
    end
    
    Note over Main,Platform: Continuous monitoring with parallel workers,<br/>error handling, and batched output
```