<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Test - Kafka Learning Lab</title>
    
    <!-- Core styles -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles/design-system.css">
    <link rel="stylesheet" href="styles/components/toast.css">
    <link rel="stylesheet" href="styles/components/module-card.css">
    <link rel="stylesheet" href="styles/components/quiz.css">
    
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .test-section {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .test-card {
            background: var(--color-gray-50);
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .test-card:hover {
            border-color: var(--color-primary-500);
            transform: translateY(-2px);
        }
        
        .test-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .test-status.success {
            background: var(--color-success-light);
            color: var(--color-success-dark);
        }
        
        .test-status.error {
            background: var(--color-error-light);
            color: var(--color-error-dark);
        }
        
        .test-status.pending {
            background: var(--color-warning-light);
            color: var(--color-warning-dark);
        }
        
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sync-indicator.syncing .fas {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 Kafka Learning Lab - Integration Test</h1>
        <p>This page tests the integration of all 4 tracks working together.</p>
        
        <!-- Sync Status Indicator -->
        <div id="sync-indicator" class="sync-indicator">
            <i class="fas fa-sync"></i>
            <span>Checking connection...</span>
        </div>
        
        <!-- Track 1: Frontend Components Test -->
        <div class="test-section">
            <h2>Track 1: Frontend Components</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Toast Notifications</h3>
                    <button onclick="testToast('success')">Success Toast</button>
                    <button onclick="testToast('error')">Error Toast</button>
                    <button onclick="testToast('info')">Info Toast</button>
                    <div id="toast-status" class="test-status pending">
                        <i class="fas fa-clock"></i> Not tested
                    </div>
                </div>
                
                <div class="test-card">
                    <h3>Progress Tracking</h3>
                    <button onclick="testProgress()">Test Progress Update</button>
                    <div id="progress-display">Current: 0%</div>
                    <div id="progress-status" class="test-status pending">
                        <i class="fas fa-clock"></i> Not tested
                    </div>
                </div>
                
                <div class="test-card">
                    <h3>Module Cards</h3>
                    <button onclick="testModuleCard()">Create Module Card</button>
                    <div id="module-card-container"></div>
                    <div id="module-status" class="test-status pending">
                        <i class="fas fa-clock"></i> Not tested
                    </div>
                </div>
                
                <div class="test-card">
                    <h3>Quiz System</h3>
                    <button onclick="testQuiz()">Launch Test Quiz</button>
                    <div id="quiz-status" class="test-status pending">
                        <i class="fas fa-clock"></i> Not tested
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Track 2: Backend Integration Test -->
        <div class="test-section">
            <h2>Track 2: Backend Integration</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>API Connection</h3>
                    <button onclick="testAPI()">Test API Health</button>
                    <div id="api-response"></div>
                    <div id="api-status" class="test-status pending">
                        <i class="fas fa-clock"></i> Not tested
                    </div>
                </div>
                
                <div class="test-card">
                    <h3>Progress Sync</h3>
                    <button onclick="testSync()">Test Progress Sync</button>
                    <div id="sync-response"></div>
                    <div id="sync-status" class="test-status pending">
                        <i class="fas fa-clock"></i> Not tested
                    </div>
                </div>
                
                <div class="test-card">
                    <h3>WebSocket Terminal</h3>
                    <button onclick="testWebSocket()">Test Terminal Connection</button>
                    <div id="ws-response"></div>
                    <div id="ws-status" class="test-status pending">
                        <i class="fas fa-clock"></i> Not tested
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Track 3: Content Test -->
        <div class="test-section">
            <h2>Track 3: Content Loading</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Week 1 Content</h3>
                    <button onclick="testContent('week1')">Load Week 1</button>
                    <div id="week1-content"></div>
                    <div id="week1-status" class="test-status pending">
                        <i class="fas fa-clock"></i> Not tested
                    </div>
                </div>
                
                <div class="test-card">
                    <h3>Quiz Content</h3>
                    <button onclick="testQuizContent()">Load Quiz Data</button>
                    <div id="quiz-content"></div>
                    <div id="quiz-content-status" class="test-status pending">
                        <i class="fas fa-clock"></i> Not tested
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Track 4: Infrastructure Test -->
        <div class="test-section">
            <h2>Track 4: Infrastructure</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Docker Status</h3>
                    <button onclick="testDocker()">Check Docker</button>
                    <div id="docker-response"></div>
                    <div id="docker-status" class="test-status pending">
                        <i class="fas fa-clock"></i> Not tested
                    </div>
                </div>
                
                <div class="test-card">
                    <h3>Lab Environment</h3>
                    <button onclick="testLab()">Test Lab Status</button>
                    <div id="lab-response"></div>
                    <div id="lab-status" class="test-status pending">
                        <i class="fas fa-clock"></i> Not tested
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Integration Test Results -->
        <div class="test-section">
            <h2>Integration Test Results</h2>
            <button onclick="runAllTests()" class="btn btn--primary">
                <i class="fas fa-play"></i> Run All Tests
            </button>
            <div id="test-results" style="margin-top: 1rem;"></div>
        </div>
    </div>
    
    <!-- Modal for quiz test -->
    <div id="quiz-modal" style="display: none;"></div>
    
    <!-- Scripts -->
    <script type="module">
        // Import integration modules
        import { apiClient } from './integration/api-client.js';
        import { progressSyncAdapter } from './integration/progress-sync-adapter.js';
        
        // Make available globally for test functions
        window.apiClient = apiClient;
        window.progressSyncAdapter = progressSyncAdapter;
        
        // Load components
        async function loadComponents() {
            try {
                const modules = await Promise.all([
                    import('./components/ui/Toast.js'),
                    import('./components/learning/ModuleCard.js'),
                    import('./components/assessment/Quiz.js'),
                    import('./services/ProgressTracker.js')
                ]);
                
                window.toast = modules[0].toast;
                window.ModuleCard = modules[1].ModuleCard;
                window.Quiz = modules[2].Quiz;
                window.progressTracker = modules[3].progressTracker;
                
                updateSyncIndicator('ready', 'Components loaded');
                
            } catch (error) {
                console.error('Failed to load components:', error);
                updateSyncIndicator('error', 'Failed to load components');
            }
        }
        
        loadComponents();
    </script>
    
    <script>
        // Test functions
        function updateStatus(elementId, success, message) {
            const status = document.getElementById(elementId);
            status.className = `test-status ${success ? 'success' : 'error'}`;
            status.innerHTML = `
                <i class="fas fa-${success ? 'check-circle' : 'times-circle'}"></i>
                ${message || (success ? 'Passed' : 'Failed')}
            `;
        }
        
        function updateSyncIndicator(status, message) {
            const indicator = document.getElementById('sync-indicator');
            indicator.className = `sync-indicator ${status}`;
            indicator.innerHTML = `
                <i class="fas fa-${status === 'syncing' ? 'sync' : status === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i>
                <span>${message}</span>
            `;
        }
        
        // Track 1 Tests
        function testToast(type) {
            try {
                window.toast[type](`Test ${type} message`);
                updateStatus('toast-status', true);
            } catch (error) {
                updateStatus('toast-status', false, error.message);
            }
        }
        
        function testProgress() {
            try {
                const progress = Math.floor(Math.random() * 100);
                window.progressTracker.updateModuleProgress('week1', progress);
                document.getElementById('progress-display').textContent = `Current: ${progress}%`;
                updateStatus('progress-status', true);
            } catch (error) {
                updateStatus('progress-status', false, error.message);
            }
        }
        
        function testModuleCard() {
            try {
                const container = document.getElementById('module-card-container');
                container.innerHTML = '';
                
                const card = new window.ModuleCard({
                    moduleId: 'test',
                    title: 'Test Module',
                    subtitle: 'Integration test',
                    progress: 75,
                    objectives: ['Test objective 1', 'Test objective 2']
                });
                
                card.mount(container);
                updateStatus('module-status', true);
            } catch (error) {
                updateStatus('module-status', false, error.message);
            }
        }
        
        function testQuiz() {
            try {
                const quiz = new window.Quiz({
                    title: 'Test Quiz',
                    questions: [{
                        question: 'Is the integration working?',
                        type: 'single',
                        options: ['Yes', 'No', 'Maybe'],
                        correct: 0
                    }],
                    onComplete: () => {
                        document.getElementById('quiz-modal').style.display = 'none';
                        updateStatus('quiz-status', true);
                    }
                });
                
                const modal = document.getElementById('quiz-modal');
                modal.style.display = 'block';
                modal.innerHTML = '';
                quiz.mount(modal);
                
            } catch (error) {
                updateStatus('quiz-status', false, error.message);
            }
        }
        
        // Track 2 Tests
        async function testAPI() {
            try {
                const response = await fetch('http://localhost:3001/health');
                const data = await response.json();
                document.getElementById('api-response').textContent = 'Status: ' + data.status;
                updateStatus('api-status', response.ok);
            } catch (error) {
                document.getElementById('api-response').textContent = 'Offline mode';
                updateStatus('api-status', false, 'Backend not available');
            }
        }
        
        async function testSync() {
            try {
                const status = window.progressSyncAdapter.getSyncStatus();
                document.getElementById('sync-response').textContent = 
                    `Online: ${status.isOnline}, Queue: ${status.queueLength}`;
                updateStatus('sync-status', true);
            } catch (error) {
                updateStatus('sync-status', false, error.message);
            }
        }
        
        function testWebSocket() {
            try {
                const ws = new WebSocket('ws://localhost:3001');
                ws.onopen = () => {
                    document.getElementById('ws-response').textContent = 'Connected';
                    updateStatus('ws-status', true);
                    ws.close();
                };
                ws.onerror = () => {
                    document.getElementById('ws-response').textContent = 'Connection failed';
                    updateStatus('ws-status', false);
                };
            } catch (error) {
                updateStatus('ws-status', false, error.message);
            }
        }
        
        // Track 3 Tests
        function testContent(weekId) {
            try {
                // Simulate content loading
                document.getElementById(`${weekId}-content`).textContent = 
                    'Content loaded: X-Ray Vision exercises';
                updateStatus(`${weekId}-status`, true);
            } catch (error) {
                updateStatus(`${weekId}-status`, false, error.message);
            }
        }
        
        function testQuizContent() {
            try {
                const quizData = {
                    questions: 8,
                    passingScore: 70,
                    topics: ['JMX', 'Metrics', 'Integration']
                };
                document.getElementById('quiz-content').textContent = 
                    JSON.stringify(quizData, null, 2);
                updateStatus('quiz-content-status', true);
            } catch (error) {
                updateStatus('quiz-content-status', false, error.message);
            }
        }
        
        // Track 4 Tests
        async function testDocker() {
            try {
                // Check if Docker commands would work
                document.getElementById('docker-response').textContent = 
                    'Docker integration ready';
                updateStatus('docker-status', true);
            } catch (error) {
                updateStatus('docker-status', false, error.message);
            }
        }
        
        function testLab() {
            try {
                // Simulate lab status check
                document.getElementById('lab-response').textContent = 
                    'Lab environment: Ready for deployment';
                updateStatus('lab-status', true);
            } catch (error) {
                updateStatus('lab-status', false, error.message);
            }
        }
        
        // Run all tests
        async function runAllTests() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<p>Running all tests...</p>';
            
            // Track 1
            testToast('success');
            testProgress();
            testModuleCard();
            
            // Track 2
            await testAPI();
            await testSync();
            testWebSocket();
            
            // Track 3
            testContent('week1');
            testQuizContent();
            
            // Track 4
            await testDocker();
            testLab();
            
            // Summary
            const statuses = document.querySelectorAll('.test-status');
            const passed = Array.from(statuses).filter(s => s.classList.contains('success')).length;
            const total = statuses.length;
            
            results.innerHTML = `
                <h3>Test Results: ${passed}/${total} Passed</h3>
                <div class="progress-bar" style="margin-top: 1rem;">
                    <div class="progress-fill" style="width: ${(passed/total)*100}%"></div>
                </div>
                <p style="margin-top: 1rem;">
                    ${passed === total ? 
                        '✅ All integration tests passed!' : 
                        '⚠️ Some tests failed. Check individual results above.'}
                </p>
            `;
        }
    </script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</body>
</html>